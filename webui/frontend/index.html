<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Analytics Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/frontend/style.css">
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üöÄ Realtime Game Monitor</h1>
    </div>

    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-value" id="val-online" style="color: #22c55e">0</div>
            <div class="stat-label">Online Players</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="val-total">0</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="val-events" style="color: #3b82f6">0</div>
            <div class="stat-label">Total Events</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        
        <div class="card">
            <div class="card-title">üî¥ Live Event Feed</div>
            <ul class="log-list" id="event-log">
                <li style="text-align:center; color: #94a3b8;">Waiting for events...</li>
            </ul>
        </div>

        <div class="card">
            <div class="card-title">üîç Inspect Player</div>
            <div class="search-container">
                <select id="player-select">
                    <option value="">-- Select a Player --</option>
                </select>
                <button class="go-btn" onclick="goToPlayer()">GO</button>
            </div>
            
            <div style="margin-top: 20px;">
                <div class="card-title">Active & Spenders</div>
                <div id="quick-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    async function fetchStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('val-online').innerText = data.online_users;
            document.getElementById('val-total').innerText = data.total_users;
            document.getElementById('val-events').innerText = data.total_events;
        } catch(e) { console.error(e); }
    }

    async function fetchEvents() {
        try {
            const res = await fetch('/api/events');
            const events = await res.json();
            const list = document.getElementById('event-log');
            
            list.innerHTML = events.map(e => {
                // Highlight ti·ªÅn n·∫øu l√† purchase
                let extraInfo = "";
                if(e.type === 'purchase') {
                    extraInfo = `<span style="color:#22c55e; font-weight:bold;">üí∞</span>`;
                }
                
                return `
                <li class="log-item">
                    <span>
                        ${extraInfo}
                        <span style="color: var(--accent); font-weight:bold;">[${e.type.toUpperCase()}]</span> 
                        Player <a href="/player/${e.id}" style="color:white; text-decoration:underline;">${e.id}</a>
                    </span>
                    <span style="color: #64748b; font-size: 0.85em;">${new Date(e.time).toLocaleTimeString()}</span>
                </li>
            `}).join('');
        } catch(e) { console.error(e); }
    }

    async function loadPlayerList() {
        try {
            const res = await fetch('/api/players_list');
            let players = await res.json();

            // 1. Populate Dropdown
            const select = document.getElementById('player-select');
            
            // [FIX] Ch·ªâ c·∫≠p nh·∫≠t Dropdown n·∫øu ng∆∞·ªùi d√πng KH√îNG ƒëang thao t√°c tr√™n n√≥
            if (document.activeElement !== select) {
                // L∆∞u l·∫°i l·ª±a ch·ªçn hi·ªán t·∫°i (n·∫øu c√≥)
                const currentSelection = select.value;

                // X√≥a v√† t·∫°o l·∫°i options
                select.innerHTML = '<option value="">-- Select a Player --</option>';
                players.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id;
                    opt.innerText = `${p.id} (${p.status})`;
                    select.appendChild(opt);
                });

                // [FIX] Kh√¥i ph·ª•c l·∫°i l·ª±a ch·ªçn c≈© sau khi render xong
                if (currentSelection) {
                    select.value = currentSelection;
                }
            }

            // 2. Quick List (Top 5 Online & Spenders) - Ph·∫ßn n√†y c·∫≠p nh·∫≠t li√™n t·ª•c ok
            const onlinePlayers = players.filter(p => p.status === 'online').slice(0, 5);
            
            const listHtml = await Promise.all(onlinePlayers.map(async (p) => {
                // L·∫•y th√™m info ti·ªÅn nong n·∫øu c·∫ßn (ƒëo·∫°n n√†y gi·ªØ nguy√™n logic c≈© c·ªßa b·∫°n)
                // ƒê·ªÉ t·ªëi ∆∞u, n·∫øu backend /api/players_list tr·∫£ v·ªÅ totalSpent th√¨ t·ªët, 
                // c√≤n ko th√¨ fetch chi ti·∫øt nh∆∞ c≈©:
                try {
                    const dRes = await fetch(`/api/player/${p.id}`);
                    const detail = await dRes.json();
                    const spent = parseFloat(detail.TotalSpent || 0).toFixed(2);
                    return `
                    <div style="padding: 10px; border-bottom: 1px solid #334155; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div style="font-weight:bold;">üü¢ ${p.id}</div>
                            <div style="font-size:0.8rem; color:#22c55e;">$${spent} spent</div>
                        </div>
                        <a href="/player/${p.id}" style="color: var(--accent); text-decoration:none; font-weight:bold;">View ‚Üí</a>
                    </div>`;
                } catch { return ""; }
            }));
            
            document.getElementById('quick-list').innerHTML = listHtml.join('') || '<div style="color:#64748b; text-align:center; padding:10px;">No active players</div>';

        } catch(e) { console.error(e); }
    }

    function goToPlayer() {
        const pid = document.getElementById('player-select').value;
        if(pid) window.location.href = `/player/${pid}`;
    }

    // Refresh
    setInterval(fetchStats, 2000);
    setInterval(fetchEvents, 1500);
    setInterval(loadPlayerList, 5000); // Refresh list ch·∫≠m h∆°n ch√∫t

    fetchStats();
    fetchEvents();
    loadPlayerList();
</script>

</body>
</html>